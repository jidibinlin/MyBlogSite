+++
title = "libfaketime + roswell + emacs æ—¶é—´æµ‹è¯•å°è¯•"
description = "å¦‚ä½•å°†æ—¶é—´è°ƒè¯•å·¥å…·libfaketiem , roswell, å’Œemacs ç»“åˆèµ·æ¥æ–¹ä¾¿çš„åšæ—¶é—´æµ‹è¯•"
date = 2022-10-04T22:13:00+08:00
lastmod = 2022-10-05T14:11:08+08:00
tags = ["tools", "common-lisp", "emacs", "lisp"]
categories = ["tools"]
draft = false
toc = true
math = true
+++

<!--more-->

å¦‚æœä½ å†™çš„ç¨‹åºç»å¸¸ä¾èµ–æ—¶é—´å»åšä¸€äº›é€»è¾‘æ§åˆ¶ï¼Œé‚£ä¹ˆä½ å¯èƒ½å¯¹è°ƒæ—¶é—´è¿™ä»¶äº‹æ¯”è¾ƒæ•æ„Ÿï¼Œä½ å¯èƒ½è¯´ä¸ä¸Šè®¨åŒï¼Œä½†æ˜¯ä¸€å®šä¸å–œæ¬¢ã€‚ç”µè„‘é¢‘ç¹è°ƒæ—¶é—´ä¼šå¯¼è‡´ä¸€äº›æ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Œæ¯”å¦‚åœ¨æˆ‘ä½¿ç”¨çš„mac m1 mini ä¸Šå°±ä¼šæœ‰äº¤æ¢å†…å­˜æš´æ¶¨40ä¸ªgçš„é—®é¢˜ã€‚è¿˜ä¼šå¯¼è‡´æ¢¯å­å¤±æ•ˆæ— æ³•è®¿é—®å¤–ç½‘ã€‚å†æ¯”å¦‚ä½ ä»¥ä¸ºæ‰ä¸Šåˆ12ç‚¹ï¼Œå®é™…ä¸Šå·²ç»æ™šä¸Šéƒ½å·²ç»ä¸‹ç­äº†,ä½ å¯¹æ—¶é—´æ²¡æœ‰æ¦‚å¿µäº†ã€‚å¦‚æœå¾€å›è°ƒæ—¶é—´æˆ‘çš„emacsè¿˜ä¼šå¡æ­»ğŸ˜®â€ğŸ’¨ã€‚ æ€»ä¹‹è°ƒæ—¶é—´å¥½åƒæ˜¯ä¸€ä»¶å°äº‹ï¼Œä½†æ˜¯å½±å“å´å¾ˆå¤§ã€‚

æ‰€ä»¥æˆ‘ä¸€ç›´åœ¨å°è¯•å¦‚ä½•åœ¨ä¸è°ƒæ—¶é—´çš„æƒ…å†µä¸‹ï¼Œç»™æŒ‡å®šç¨‹åºä¸€ä¸ªå‡çš„æ—¶é—´ã€‚æˆ‘æ›¾è¯•è¿‡ç”¨å®¹å™¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸è¿‡å®¹å™¨å†…çš„æ—¶é—´ä¼šå®šæ—¶å’Œå®¿ä¸»æœºåŒæ­¥ï¼Œå¹¶ä¸èƒ½è§£å†³æ—¶é—´é—®é¢˜ã€‚åæ¥æˆ‘å‘ç°äº†libfaketimeè¿™ä¸ªå·¥å…·ï¼Œä¸è¿‡å¼„äº†åŠå¤©ä¸€ç›´æ²¡èƒ½åœ¨æˆ‘çš„mac m1 ä¸Šæ­£å¸¸ä½¿ç”¨ã€‚æœ€è¿‘æˆ‘åˆé‡åˆ°äº†è¦é¢‘ç¹è°ƒæ—¶é—´çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸‹å®šå†³å¿ƒè¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

é‚£ä¹ˆåœ¨è¿™ç¯‡blogä¸­ï¼Œä½ å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨libfaketime,å¦‚ä½•ä½¿ç”¨roswellè„šæœ¬åˆ¶ä½œæŒ‡å®šç¨‹åºçš„libfaketime ç¯å¢ƒï¼ˆå…ˆåˆå§‹åŒ–æ—¶é—´ç¯å¢ƒï¼Œå†å¯åŠ¨æŒ‡å®šç¨‹åºï¼‰ï¼Œæœ€åæ˜¯å¦‚ä½•ä½¿ç”¨emacsä¸€é”®å¯åŠ¨ã€‚


## libfaketime å®‰è£… {#libfaketime-å®‰è£…}

å¯¹äºä¸åŒçš„ç¯å¢ƒï¼Œlibfaketimeçš„å®‰è£…æ–¹æ³•ä¹Ÿä¸ç›¸åŒã€‚

-   å¯¹äºmacå¦‚æœä½ ä½¿ç”¨homebrew(homebrewå¦‚ä½•å®‰è£…æˆ‘å°±ä¸èµ˜è¿°äº†)

    > brew install libfaketime

-   å¯¹äºlinux ä½ å¯ä»¥ç ”ç©¶ä¸‹è‡ªå·±å‘è¡Œç‰ˆçš„åŒ…ç®¡ç†å™¨ï¼Œæ¯”å¦‚ubuntu

    > sudo apt-get install libfaketime

-   windowså˜›ï¼Œæˆ‘è®¨åŒwindowsæŠµåˆ¶ç¨‹åºå‘˜ä½¿ç”¨windowsã€‚æ‰€ä»¥å°±ä¸ä»‹ç»äº†ï¼ˆä¸è¿‡æˆ‘å»ºè®®ä½ ç”¨wsl,æŠŠwindowså½“ä½œlinuxçš„å­ç³»ç»ŸğŸ˜ï¼‰

-   è¿˜æœ‰ä¸€ç§æºç ç¼–è¯‘çš„å®‰è£…æ–¹å¼ï¼Œä½ ä»¬å¯ä»¥çœ‹ä¸‹libfaketime çš„è‡ªè¿°æ–‡ä»¶[libfaketime-readme](https://github.com/wolfcw/libfaketime/blob/master/README)


## å¦‚ä½•ä½¿ç”¨libfaketime {#å¦‚ä½•ä½¿ç”¨libfaketime}

å®‰è£…å®Œæˆåï¼Œä½ æœ‰ä¸¤ä»¶äº‹æƒ…è¦åšã€‚

-   ç¬¬ä¸€ä¸ªè¯»ä¸€élibfaketimeçš„readmeã€‚å¯¹äºmacæ¥è¯´ä½ åº”è¯¥è¯»ä¸€é[libfaketime-mac-readme](https://github.com/wolfcw/libfaketime/blob/master/README.OSX)
-   ç¬¬äºŒä¸ªï¼Œä½ éœ€è¦çŸ¥é“libfaketimeçš„åŠ¨æ€é“¾æ¥åº“è¢«å‘åˆ°äº†å“ªä¸ªç›®å½•ä¸‹é¢(brewå®‰è£…çš„æ˜¯ /opt/homebrew/lib/faketime/libfaketime.1.dylib)

libfaketimeå¤§æ¦‚çš„åŸç†å°±æ˜¯ï¼Œè®©ç¨‹åºé“¾æ¥libfaketimeçš„åº“è¾¾åˆ°æ”¹æ—¶é—´çš„ç›®çš„ï¼ˆå…è®¸æˆ‘è¿™ä¹ˆæ½¦è‰ğŸ˜„ï¼Œæ¯•ç«Ÿè¿™ä¸ªåº“ä¸æ˜¯æˆ‘å†™çš„ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥è®©ç¨‹åºè‡ªå·±é“¾æ¥libfaketimeã€‚
åœ¨unixç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡çš„æ–¹å¼æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„

-   macä¸‹ä½ éœ€è¦
    ```sh
    export DYLD_FORCE_FLAT_NAMESPACE=1
    export DYLD_INSERT_LIBRARIES=/path/to/libfaketime.1.dylib
    ```
-   linuxä¸‹ä½ éœ€è¦
    ```sh
    export LDPRELOAD=/path/to/libfaketime.1.so
    ```

-   åœ¨ä½ æ­£ç¡®è®¾ç½®äº†ä¸Šé¢çš„ç¯å¢ƒå˜é‡åï¼ˆmac ä¸‹æœ€å¥½é€šè¿‡export è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæˆ‘è¯•è¿‡ç›´æ¥åœ¨ç¨‹åºå‰é¢è®¾ç½®ä½†æ˜¯æ²¡æˆåŠŸï¼‰,ä½ å¯ä»¥é€šè¿‡åœ¨ç¨‹åºå¯åŠ¨å‰è®¾ç½® "faketime" è¿™ä¸ªç¯å¢ƒå˜é‡æ¥è¾¾åˆ°æ§åˆ¶ç¨‹åºæ—¶é—´çš„ç›®çš„ã€‚

    faketimeæœ‰å¾ˆå¤šä¸­è®¾ç½®æ ¼å¼ï¼Œæˆ‘åªä»‹ç»å¦‚ä½•è®¾ç½®æŒ‡å®šæ—¶é—´ï¼Œå¹¶è®©æ—¶é—´è‡ªç„¶æµé€çš„æ–¹æ³•ã€‚libfaketimeè¿˜æœ‰å¾ˆå¤šç”¨æ³•ï¼Œéƒ½å¯ä»¥åœ¨å®˜æ–¹çš„è‡ªè¿°æ–‡ä»¶é‡Œé¢çœ‹åˆ°ã€‚

    ç°åœ¨ç›´æ¥ä¸Šå‘½ä»¤
    ```sh
    export faketime_dont_reset=1
    export faketime="@2022-08-20 00:00:00"
    ```
    "@"å­—ç¬¦å¾ˆå…³é”®ï¼Œæ²¡æœ‰""@"æ—¶é—´å°†ä¸ä¼šè‡ªåŠ¨æµé€,å¦å¤–faketime_dont_resetè¿™ä¸ªå˜é‡æœ‰æ—¶å€™ä¹Ÿä¸ç”¨è®¾ç½®ï¼Œä½†æ˜¯å¦‚æœä½ å‘ç°ç¨‹åºæ—¶é—´å’Œä½ é¢„æœŸçš„ä¸ä¸€æ ·ï¼Œä½ åº”è¯¥æŠŠfaketime_dont_resetè®¾ç½®ä¸º1(å…·ä½“åŸå› ä½ å¯ä»¥å»çœ‹è‡ªè¿°æ–‡ä»¶)

-   æœ€åä¸€æ­¥å°±æ˜¯å¯åŠ¨ç¨‹åºï¼Œä¸éœ€è¦æˆ‘æ•™ä½ å§ğŸ˜Š


## å¦‚ä½•ä½¿ç”¨roswell åˆå§‹åŒ–ä¸€ä¸ªlibfaketimeç¯å¢ƒ {#å¦‚ä½•ä½¿ç”¨roswell-åˆå§‹åŒ–ä¸€ä¸ªlibfaketimeç¯å¢ƒ}

å…ˆä»‹ç»ä¸€ä¸‹roswellã€‚roswell æ˜¯ä¸€ä¸ªcommon lisp çš„å®ç°ç®¡ç†å·¥å…·ï¼Œä½†æ˜¯ä»–è‡ªèº«æœ‰æŒºå¤šçš„é™„å¸¦åŠŸèƒ½ã€‚å…¶ä¸­ä¸€ä¸ªå°±æ˜¯å¯ä»¥ä½œä¸ºbash è„šæœ¬çš„æ›¿ä»£å“ï¼Œç”¨common lisp å»å†™è„šæœ¬ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œcommon lispè¦æ¯”shellè„šæœ¬å¥½å†™ä¸€ç‚¹ï¼ˆä¸»è¦æ˜¯ä¸åƒshellé‚£ä¹ˆå®¹æ˜“å‡ºé”™shellè„šæœ¬ä¸€ä¸ªç©ºæ ¼ä¸å¯¹éƒ½ä¸è¡ŒğŸ˜’ï¼‰ã€‚å†è€…å°±æ˜¯ï¼Œåˆ©ç”¨repl,ä½ å¯ä»¥éå¸¸æ–¹ä¾¿çš„è°ƒè¯•roswellè„šæœ¬ï¼ˆåŠ¨æ€è¯­è¨€çš„replç®€ç›´ä¸è¦å¤ªé¦™ï¼Œå¼€å‘æ•ˆç‡çœŸçš„è¦æ¯”goé‚£ç§é™æ€è¯­è¨€é«˜ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä¸é€‰goçš„åŸå› ï¼‰ã€‚

å¦‚æœä½ ä¸å–œæ¬¢common lisp, ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨pythonè¿™æ ·çš„è„šæœ¬è¯­è¨€ï¼Œä¹Ÿèƒ½è¾¾åˆ°ä¸€æ ·ç”šè‡³æ›´å¥½çš„æ•ˆæœã€‚æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹æˆ‘çš„æ€è·¯ï¼Œå…¶å®å°±ä¸€å¥è¯ï¼Œä½¿ç”¨è„šæœ¬è¯­è¨€å»è®¾ç½®libfaketimeçš„ä¸€ç³»åˆ—ç¯å¢ƒå˜é‡ï¼Œç„¶åå¯åŠ¨ç¨‹åºã€‚ä½ å¯ä»¥ç»™è„šæœ¬è¯­è¨€åŠ ä¸Šå‡ ä¸ªå‚æ•° æ¯”å¦‚ç¨‹åºçš„è·¯å¾„ï¼Œä½ æƒ³è¦è®¾ç½®çš„æ—¶é—´ç­‰ç­‰å»æ§åˆ¶è„šæœ¬çš„è¡Œä¸ºè¿™éƒ½å–å†³äºä½ è‡ªå·±äº†

ä½¿ç”¨roswellä½œä¸ºè„šæœ¬ï¼Œä½ å°±éœ€è¦çŸ¥é“å¦‚ä½•ä½¿ç”¨common lispçš„ä¸€äº›ä¸ç³»ç»Ÿäº¤äº’çš„åº“ï¼Œæ¯”å¦‚å¦‚ä½•è§£æå‘½ä»¤è¡Œçš„å‚æ•°å¯ä»¥ä½¿ç”¨ unix-optsè¿™ä¸ªåº“ã€‚çœ‹ä»£ç å–½(çœ‹ä¸æ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œä½ å¯ä»¥ç”¨ä½ å–œæ¬¢çš„è¯­è¨€ç”šè‡³shellè„šæœ¬è‡ªå·±ç ”ç©¶ä¸‹ï¼Œå¾ˆå¥½å†™çš„)

è¿™æ®µè„šæœ¬çš„è¡Œä¸ºæ˜¯ï¼Œ æ¥å—ä¸€ä¸ª-eå‚æ•° ç”¨æ¥æŒ‡å®šç¨‹åºçš„è·¯å¾„,ä»¥åŠä¸€ä¸ª-tå‚æ•°ç”¨æ¥æŒ‡å®šæ—¶é—´

```lisp
#!/bin/sh
#|-*- mode:lisp -*-|#
#|
exec ros -Q -- $0 "$@"
|#
(progn ;;init forms
  (ros:ensure-asdf)
  #+quicklisp(ql:quickload '() :silent t)
  )

(defpackage :ros.script.luna_time_tast.3869869288
  (:use :cl))
(in-package :ros.script.luna_time_tast.3869869288)


(ql:quickload "unix-opts")

(ql:quickload "uiop")

;; å®šä¹‰å‘½ä»¤è¡Œå‚æ•°
(opts:define-opts
  (:name :bin-path
   :description "binary path to be executed"
   :short #\e
   :long "bin_path"
   :arg-parser #'uiop:native-namestring)
  (:name :time
   :description "time to be used"
   :short #\t
   :long "time"
   :arg-parser #'string)
  )

(defun main (&rest argv)
  (declare (ignorable argv))
  ;; è§£æå‘½ä»¤è¡Œå‚æ•°
  (multiple-value-bind (options)
      (opts:get-opts argv)
    (let* ((binary-path (getf options :bin-path))
           ;;æ‰¾åˆ°ç¨‹åºçš„çˆ¶ç›®å½•
           (dir (uiop:pathname-directory-pathname binary-path))
           (time (getf options :time)))
      ;; è®¾ç½®libfaketimeç¯å¢ƒå˜é‡
      (sb-posix:setenv "DYLD_FORCE_FLAT_NAMESPACE" "1" 1)
      (sb-posix:setenv "DYLD_INSERT_LIBRARIES" "/opt/homebrew/lib/faketime/libfaketime.1.dylib" 1)
      (sb-posix:setenv "FAKETIME_DONT_RESET" "1" 1)
      (sb-posix:setenv "FAKETIME" time 1)

      ;; åˆ‡æ¢åˆ°ç¨‹åºç›®å½•
      (uiop:chdir dir)
      ;;æ‰§è¡Œç¨‹åº
      (uiop:run-program (list "./game"))
      )
    )
  )
```


## emacsé›†æˆ {#emacsé›†æˆ}

å…¶å®æˆ‘ä¼šç”¨common lispå½“ä½œè„šæœ¬è¯­è¨€æ˜¯å› ä¸ºæˆ‘æ¯”è¾ƒå–œæ¬¢ç”¨emacs, hack emacséœ€è¦ç”¨åˆ°lisp è¿™æ ·çš„è¯­è¨€ã€‚emacs éœ€è¦åšçš„æ˜¯å°è£…interactiveå‡½æ•°å»å¼‚æ­¥è°ƒç”¨ä¸Šè¿°çš„è„šæœ¬ã€‚

```lisp
;; ä¸€ä¸ªæ—¶é—´å˜é‡ï¼Œåé¢ä¼šå¸¦å…¥è„šæœ¬
(setq luna_time "@2022-08-23 23:59:20")
;; è„šæœ¬çš„è·¯å¾„
(setq luna_run "/Users/qibinyang/Data/luna_time_test/luna_time_tast.ros")
(defun cycle-rank-test()
  "test luna game"
  (interactive)
  ;; å¼‚æ­¥è°ƒç”¨è„šæœ¬æ‰§è¡Œæˆ‘æƒ³è¦è°ƒæ—¶é—´çš„ç¨‹åº æˆ‘çš„å·¥ä½œæ˜¯æ¸¸æˆå¼€å‘ï¼Œæœ€è¿‘åœ¨åšè·¨æœä¸šåŠ¡æ‰€ä»¥ä¼šå¼€ä¸‰ä¸ª
  (start-process "run_game" (get-buffer "*Messages*") luna_run "-e" "/opt/cycle_test/game/game" "-t" luna_time)

  (start-process "run_game" (get-buffer "*Messages*") luna_run "-e" "/opt/cycle_test/game2/game" "-t" luna_time)

  (start-process "run_game" (get-buffer "*Messages*") luna_run "-e" "/opt/cycle_test/game_center/game" "-t" luna_time)
  )
```

è¿™æ ·æˆ‘å°±å¯ä»¥åœ¨emacs ä¸­ M-x cycle-rank-test å°†"20200-08-23 23:59:20" è¿™ä¸ªæ—¶é—´å¸¦å…¥åˆ°ç¨‹åºä¸­ã€‚å¦‚æœæˆ‘æƒ³æ¢ä¸€ä¸ªæ—¶é—´ï¼Œåªéœ€è¦ä¿®æ”¹luna_timeè¿™ä¸ªå˜é‡ï¼Œç„¶åé‡å¯ç¨‹åºå³å¯ã€‚


## æ€»ç»“ {#æ€»ç»“}

æ¯•ä¸šåˆ°å·¥ä½œæœ‰ä¸€å¹´çš„æ—¶é—´äº†ï¼Œç»å†äº†æŒºå¤šçš„äº‹æƒ…çš„ã€‚å°è±¡æœ€æ·±çš„æ˜¯å¤±æ‹ä»¥åï¼Œåˆæ…¢æ…¢çš„é‡æ•´æ——é¼“ï¼Œå¥èº«æ”¹é€ è‡ªå·±ï¼Œå’Œè‡ªå·±å¯¹è¯æ…¢æ…¢çš„èµ°å‡ºä»¥å‰çš„æ¼©æ¶¡ã€‚ä¿æŒç§¯æçš„å¿ƒæ€ï¼Œæ…¢æ…¢çš„æ¥å—æ–°çš„æ€æƒ³ï¼Œæ–°çš„ç†å¿µã€‚é”»ç‚¼èº«ä½“ï¼Œä¹Ÿé”»ç‚¼è‡ªå·±çš„å†…å¿ƒã€‚æ…¢æ…¢æ¥å—å˜åŒ–ï¼Œå‘ç€ä¸æƒ§æ€•å˜åŒ–å‰è¿›ã€‚è¿™äº›æ”¹å˜ç¡®å®ç»™æˆ‘å¸¦æ¥äº†æˆ‘æ²¡æœ‰æƒ³åˆ°çš„å¥½å¤„ã€‚

æœ€è¿‘æœ‰æ–­æ—¶é—´æ²¡å†™åšå®¢äº†ï¼Œæ‰€ä»¥ä»Šå¤©è¡¥ä¸Šä¸€ç¯‡å·¥ä½œæ—¥è®°ã€‚ä»é«˜ä¸­çš„æ—¶å€™å°±æ¥è§¦åˆ°linuxï¼Œåœ¨linuxå’Œç¼–è¾‘å™¨ä¸Šæµªè´¹äº†å¤§é‡çš„æ—¶é—´ã€‚ç°åœ¨é€æ¸ç¨³å®šä¸‹æ¥ï¼Œæœªæ¥çš„åŠå¹´åº”è¯¥æŠŠé‡ç‚¹æ”¾åœ¨ç®—æ³•å’Œåç«¯æ¶æ„çš„ç†è§£ä¸Šï¼Œå…¼é¡¾å¼€å‘ä¸€äº›å°å·¥å…·ï¼Œæå‡è‡ªå·±çš„æ•ˆç‡ã€‚æœ€è¿‘å¯¹è‡ªå·±çš„ç¼–ç é£æ ¼ä¹Ÿä¸æ˜¯å¾ˆæ»¡æ„ï¼Œå†™çš„ç¨‹åºæœ‰ç‚¹ä¹±è¿˜å¾—æ³¨æ„ä¸€ä¸‹ã€‚

æœ€æ€•æ‡’åœ¨åºŠä¸Šï¼Œå›°åœ¨æ‰‹æœºé‡Œï¼Œè¢«ä½çº§è¶£å‘³æ¶ˆç£¨æ„å¿—ã€‚
